<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="portal_my_orders_new" name="My Sales Orders">
        <t t-call="portal.portal_layout">
            <t t-set="breadcrumbs_searchbar" t-value="True"/>

            <t t-call="portal.portal_searchbar">
                <t t-set="title">Sales Orders</t>
            </t>
            <t t-if="not orders">
                <p>There are currently no orders for your account.</p>
            </t>
            <t t-if="orders">
                <div class="orders_container clearfix">
                    <div class="my_orders_outer">
                        <t t-foreach="orders" t-as="order">
                            <div class="my_orders">
                                <div class="my_orders_row">
                                    <table class="my_orders_table">
                                        <tr>
                                            <td><span class='d-md-inline'>Order Number</span><br></br>
                                                <span> <t t-esc="order.name"/> </span></td>
                                            <td class="">
                                                <span>Order Date</span> <br></br>
    <!--                                            <span t-field="order.date_order" t-options="{'widget': 'date'}"/>&amp;nbsp;-->
    <!--                                            <span class='d-none d-md-inline' t-field="order.date_order" t-options="{'time_only': True}"/>-->
                                                <span class="d-md-inline"><t t-esc="order.date_order.strftime('%d %b %Y')" /></span>
                                            </td>
                                            <td class="d-none">
                                                <span>Total</span> <br></br>
                                                <span t-field="order.amount_total"/></td>
                                            <td></td>
                                            <td></td>
                                            <td>
                                                <a t-att-href="order.get_portal_url()"> View Order Details </a>
                                            </td>
                                        </tr>

                                    </table>

                                </div>
                                <div class="my_orders_box">
                                    <table class="cart_modal_table">
                                        <t t-foreach="order.order_line" t-as="line">

                                            <tr t-if="not line.is_delivery" t-att-data-product-id='line.product_id.id'>
                                                <td align="center" t-if="line.product_id.product_tmpl_id" class='td-img'>
                                                    <span t-field="line.product_id.image_128" t-options="{'widget': 'image', 'qweb_img_responsive': False, 'class': 'rounded o_image_64_max'}" />
                                                </td>
                                                <td>
                                                    <div class="col-9">
                                                        <div>
                                                            <t t-call="website_sale.cart_line_product_link">
                                                                <span class="h6" t-esc="line.name_short" />
                                                            </t>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td class="td-price">
                                                    <span t-field="line.price_reduce_taxexcl" style="white-space: nowrap;" t-options="{'widget': 'monetary', 'display_currency': line.currency_id}" groups="account.group_show_line_subtotals_tax_excluded" />
                                                    <span t-field="line.price_reduce_taxinc" style="white-space: nowrap;" t-options="{'widget': 'monetary', 'display_currency': line.currency_id}" groups="account.group_show_line_subtotals_tax_included" />
                                                </td>
<!--                                                <td>-->
<!--                                                    <input type="hidden" name="product_id"  class="product_template_id" t-att-value="line.product_id.id"/>-->
<!--                                                    <a id="buy-again" class="btn mt8 js_check_product a-submit wk_test"-->
<!--                                                       >Buy it again</a>-->
<!--                                                </td>-->
                                            </tr>
                                        </t>
                                    </table>

                                </div>
                            </div>
                        </t>

                        <div t-if="pager" class="o_portal_pager text-center">
                            <t t-call="portal.pager"/>
                        </div>
                    </div>
                    <div class="ordered_products_container">
                        <h3>Purchased Products</h3>
                        <div class="ordered_products_box">
                            <t t-foreach="order_lines" t-as="line">
                                <div t-if="not line.is_delivery" t-att-data-product-id='line.product_id.id' class="ordered_product">
                                    <div align="center" t-if="line.product_id.product_tmpl_id" class='td-img ordered_product_img'>
                                        <span t-field="line.product_id.image_128" t-options="{'widget': 'image', 'qweb_img_responsive': False, 'class': 'rounded'}" />
                                    </div>
                                    <div class="ordered_product_details" t-att-data-product-id='line.product_id.id'>
                                        <div>
                                            <t t-call="website_sale.cart_line_product_link">
                                                <span class="h6" t-esc="line.name_short" />
                                            </t>
                                        </div>
                                        <div class="td-price">
                                            <span t-field="line.price_reduce_taxexcl" style="white-space: nowrap;" t-options="{'widget': 'monetary', 'display_currency': line.currency_id}" groups="account.group_show_line_subtotals_tax_excluded" />
                                            <span t-field="line.price_reduce_taxinc" style="white-space: nowrap;" t-options="{'widget': 'monetary', 'display_currency': line.currency_id}" groups="account.group_show_line_subtotals_tax_included" />
                                        </div>
                                        <div>
                                            <span>Ordered at: <t t-esc="line.create_date.strftime('%d %b %Y')" /></span>
                                        </div>
                                        <div>
                                            <input type="hidden" name="product_id"  class="product_template_id" t-att-value="line.product_id.id"/>
                                            <a id="buy-again2" class="btn mt8 js_check_product a-submit wk_test">Purchase again</a>
                                        </div>
                                    </div>

                                </div>
                            </t>
                        </div>
                    </div>
                </div>
            </t>
        </t>
    </template>

    <template id="portal_table_new" name="My Portal Table">
        <div t-attf-class="table-responsive border rounded border-top-0 #{classes if classes else ''}">
            <table class="table rounded mb-0 bg-white portal_orders_table">
                <t t-raw="0"/>
            </table>
        </div>
        <div t-if="pager" class="o_portal_pager text-center">
            <t t-call="portal.pager"/>
        </div>
    </template>

    <template id="order_details_page">
        <t t-call="portal.portal_layout">
            <t t-set="breadcrumbs_searchbar" t-value="True"/>

            <t t-call="portal.portal_searchbar">
                <t t-set="title">Sales Orders</t>
            </t>

            <div class="order_details_outer">
                <div class="order_details_header clearfix">
                    <div class="inner_header">
                        <h2>Order Details</h2>
                        <h5>Order ID <t t-esc="sale_order.name"/> </h5>
                    </div>
                    <div class="download_box o_download_pdf btn-toolbar flex-sm-nowrap">
                        <div class="btn-group flex-grow-1 mb-1">
                            <a class="btn btn-secondary btn-block o_download_btn" t-att-href="sale_order.get_portal_url(report_type='pdf', download=True)" title="Download"><i class="fa fa-download"/> Download</a>
                        </div>
                        <div class="btn-group flex-grow-1 mb-1">
                            <a class="btn btn-secondary btn-block o_print_btn o_portal_invoice_print" t-att-href="sale_order.get_portal_url(report_type='pdf')" id="print_invoice_report" title="Print" target="_blank"><i class="fa fa-print"/> Print</a>
                        </div>
                    </div>
                </div>
                <div class="order_details_body clearfix">
                    <div class="orders_left_box">
                        <div class="order_progress_container">
                            <ul class="order_progress">
                                <t t-foreach="delivery_progress" t-as="pro">
                                    <li t-attf-class="#{pro_value[0]}">
                                        <span t-attf-class="#{pro_value[0]}_bar"></span>
                                        <t t-if="pro_value[0] == 'complete'">
                                            <span>
                                                <span><i class="fa fa-check-circle"></i></span>
                                                <h5 class="#{pro_value[0]}"><t t-esc="pro" /> </h5>
<!--                                                <h6 class="#{pro_value[0]}"><t t-esc="pro_value[1]"/> </h6>-->
                                            </span>
                                        </t>
                                        <t t-else="">
                                            <span>
                                                <span><i class="fa fa-circle"></i> </span>
                                                <h5 class="#{pro_value[0]}"><t t-esc="pro" /> </h5>
<!--                                                <h6 class="#{pro_value[0]}"><t t-esc="pro_value[1]"/> </h6>-->
                                            </span>
                                        </t>
                                    </li>
                                </t>
                            </ul>
                        </div>
                        <div class="table_box">
                            <table class="cart_modal_table">
                                <thead>
                                    <tr>
                                        <th></th>
                                        <th class="text-left">Products</th>
                                        <th class="text-right">Quantity</th>
                                        <th t-attf-class="text-right {{ 'd-none d-sm-table-cell' if report_type == 'html' else '' }}">Unit Price</th>
                                        <th t-if="display_discount" t-attf-class="text-right {{ 'd-none d-sm-table-cell' if report_type == 'html' else '' }}">
                                            <span>Disc.%</span>
                                        </th>
    <!--                                    <th t-attf-class="text-right {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">-->
    <!--                                        <span>Taxes</span>-->
    <!--                                    </th>-->
                                        <th class="text-right" >
                                            <span groups="account.group_show_line_subtotals_tax_excluded">Amount</span>
                                            <span groups="account.group_show_line_subtotals_tax_included">Total Price</span>
                                        </th>
                                    </tr>
                                </thead>
                                <t t-foreach="sale_order.order_line" t-as="line">
                                    <tr t-if="not line.is_delivery" t-att-data-product-id='line.product_id.id'>
                                        <t t-if="not line.display_type">
                                        <td align="center" t-if="line.product_id.product_tmpl_id" class='td-img'>
                                            <span t-field="line.product_id.image_128" t-options="{'widget': 'image', 'qweb_img_responsive': False, 'class': 'rounded'}" />
                                        </td>
                                        <td class="width_40">
                                            <div>
                                                <div>
                                                    <t t-call="website_sale.cart_line_product_link">
                                                        <span class="h6" t-esc="line.name_short" />
                                                    </t>
                                                    <t t-foreach="line.product_template_attribute_value_ids" t-as="attr">
                                                        <p class="">
                                                            <span><t t-esc="attr.attribute_id.name"/> -
                                                                <t t-esc="attr.product_attribute_value_id.name" />
                                                            </span>
                                                        </p>
                                                    </t>
                                                    <p class="attribute_text"> Sold by: <t t-esc="line.product_id.marketplace_seller_id.name"/> </p>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="text-right">
                                            <div id="quote_qty">
                                                <span t-field="line.product_uom_qty"/>
                                                <span t-field="line.product_uom" groups="uom.group_uom"/>
                                            </div>
                                        </td>
                                        <td t-attf-class="text-right {{ 'd-none d-sm-table-cell' if report_type == 'html' else '' }}">
                                            <div
                                                t-if="line.discount &gt;= 0"
                                                t-field="line.price_unit"
                                                t-att-style="line.discount and 'text-decoration: line-through' or None"
                                                t-att-class="(line.discount and 'text-danger' or '') + ' text-right'"
                                            />
                                            <div t-if="line.discount">
                                                <t t-esc="(1-line.discount / 100.0) * line.price_unit" t-options='{"widget": "float", "decimal_precision": "Product Price"}'/>
                                            </div>
                                        </td>
                                        <td t-if="display_discount" t-attf-class="text-right {{ 'd-none d-sm-table-cell' if report_type == 'html' else '' }}">
                                            <strong t-if="line.discount &gt; 0" class="text-info">
                                                <t t-esc="((line.discount % 1) and '%s' or '%d') % line.discount"/>%
                                            </strong>
                                        </td>
    <!--                                    <td t-attf-class="text-right {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">-->
    <!--                                        <span t-esc="', '.join(map(lambda x: (x.description or x.name), line.tax_id))"/>-->
    <!--                                    </td>-->
                                        <td class="text-right">
                                            <h6 class="oe_order_line_price_subtotal" t-field="line.price_subtotal" groups="account.group_show_line_subtotals_tax_excluded"/>
                                            <h6 class="oe_order_line_price_total" t-field="line.price_total" groups="account.group_show_line_subtotals_tax_included"/>
                                        </td>
                                    </t>
                                    <t t-if="line.display_type == 'line_section'">
                                        <td colspan="99">
                                            <span t-field="line.name"/>
                                        </td>
                                        <t t-set="current_section" t-value="line"/>
                                        <t t-set="current_subtotal" t-value="0"/>
                                    </t>
                                    <t t-if="line.display_type == 'line_note'">
                                        <td colspan="99">
                                            <span t-field="line.name"/>
                                        </td>
                                    </t>

                                    </tr>
                                </t>
                            </table>

                            <div id="order_details_total" name="total" style="page-break-inside: avoid;">
                                <div>
                                    <!-- Should be replaced in master by t-call="sale.sale_order_portal_content_totals_table" -->
                                    <table class="">
                                        <tr>
                                            <td><strong>Delivery</strong></td>
                                            <td class="text-right" >
                                               <span t-field="sale_order.amount_delivery" class="monetary_field" style="white-space: nowrap;"
                                                     t-options='{
                                                  "widget": "monetary",
                                                  "display_currency": sale_order.currency_id,
                                              }'/>
                                          </td>
                                        </tr>
                                        <tr class="border-black">
                                            <td><strong>Subtotal</strong></td>
                                            <td class="text-right">
                                                <span
                                                    data-id="total_untaxed"
                                                    t-field="sale_order.amount_untaxed"
                                                    t-options='{"widget": "monetary","display_currency": sale_order.pricelist_id.currency_id}'
                                                />
                                            </td>
                                        </tr>
                                        <t t-foreach="sale_order.amount_by_group" t-as="amount_by_group">
                                            <tr>
                                                <t t-if="amount_by_group[3] == 1 and sale_order.amount_untaxed == amount_by_group[2]">
                                                    <td>
                                                        <span t-esc="amount_by_group[0]"/>
                                                        <span>&amp;nbsp;<span>on</span>&amp;nbsp;<t t-esc="amount_by_group[2]" t-options='{"widget": "monetary", "display_currency": sale_order.pricelist_id.currency_id}'/></span>
                                                    </td>
                                                    <td class="text-right">
                                                        <span t-esc="amount_by_group[1]"
                                                            t-options='{"widget": "monetary", "display_currency": sale_order.pricelist_id.currency_id}'/>
                                                    </td>
                                                </t>
                                                <t t-else ="">
                                                    <td>
                                                        <span t-esc="amount_by_group[0]"/>
                                                    </td>
                                                    <td class="text-right">
                                                        <span t-esc="amount_by_group[1]"
                                                            t-options='{"widget": "monetary", "display_currency": sale_order.pricelist_id.currency_id}'/>
                                                    </td>
                                                </t>
                                            </tr>
                                        </t>
                                        <tr class="border-black">
                                            <td><strong>Total</strong></td>
                                            <td class="text-right">
                                                <span data-id="total_amount" t-field="sale_order.amount_total" t-options='{"widget": "monetary", "display_currency": sale_order.pricelist_id.currency_id}'/>
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="orders_right_box clearfix">
                        <div class="order_history">
                            <h3>Order History</h3>
                            <div class="order_history_inner">
                                <t t-foreach="delivery_progress" t-as="pro">
                                    <div class="order_status">
                                        <h5 t-attf-class="is_#{pro_value[0]}"><t t-esc="pro" />
                                            <span t-if="pro_value[0] == 'complete'"><i class="fa fa-check-circle"/></span> </h5>
                                        <p><t t-esc="pro_value[1]"/> </p>
                                    </div>
                                </t>
                            </div>
                        </div>
                        <div class="customer_details">
                            <h3>Customer Details</h3>

                            <div class="shipping_address">
                                <h5><strong>Shipping Address:</strong></h5>
                                <div t-field="sale_order.partner_shipping_id"
                                    t-options='{"widget": "contact", "fields": ["address", "name", "phone"], "no_marker": True, "phone_icons": True}'/>
                            </div>

                            <div class="payment_info">

                                <t t-if="sale_order.transaction_ids">
                                    <t t-set="payment_tx_id" t-value="sale_order.get_portal_last_transaction()"/>
                                    <t t-set="reference" t-value="sale_order.reference"/>
                                    <h5><strong>Payment Method: </strong></h5>

                                    <span align="center" t-if="payment_tx_id.acquirer_id.image_128" class='td-img'>
                                        <span t-field="payment_tx_id.acquirer_id.image_128" t-options="{'widget': 'image', 'qweb_img_responsive': False, 'class': 'rounded'}" />
                                    </span>
                                    <span><t t-esc="payment_tx_id.acquirer_id.name"/></span>
                                </t>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </t>
    </template>
</odoo>